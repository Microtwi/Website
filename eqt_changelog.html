<!DOCTYPE html>
<html>

<head>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link rel="stylesheet" href="style_0.10.00.00.css">
    <script src="core_0.10.00.00.js"></script>
    <script defer src="Assets/sharedLayout.js"></script>
    <link rel="icon" type="image/png" href="/favicon.png">
    <title>Microtwi - Equinox Tales Changelog</title>
</head>

<script>
    setTimeout(initializedContextMenu, 100);
    setTimeout(initializedModalVers, 150);
</script>

<body>
    <div class="bgImageEQT"></div>

    <div class="offset">
        <div class="contentBg">
            <input id="changelog-filter" type="text" placeholder="Filter by tag, version, or keyword">
        </div>
        <div id="changelog-list" class="changelog-list">
            <div class="contentBg">
                Loading changelog data…
            </div>
        </div>
    </div>

    <script>
        const changelogContainer = document.getElementById("changelog-list");
        const filterInput = document.getElementById("changelog-filter");
        let changelogEntries = [];

        function listToHtml(items) {
            if (!items || !items.length) return "<li>None listed.</li>";
            return items.map(item => `<li>${item}</li>`).join("");
        }

        function highlightMatches(entry, query) {
            const fieldValues = [
                entry.version,
                entry.summary,
                entry.date,
                ...(entry.details || []),
                ...(entry.tags || [])
            ];
            return fieldValues.some(value => value && value.toLowerCase().includes(query));
        }

        function renderChangelog(entries) {
            if (!entries || !entries.length) {
                changelogContainer.innerHTML = `<br><div class="contentBg">No updates found.</div>`;
                return;
            }

            changelogContainer.innerHTML = entries
                .map(entry => {
                    const details = listToHtml(entry.details);
                    const tags = (entry.tags || [])
                        .filter(Boolean)
                        .map(tag => `<span class="heroText changelog-tag">${tag}</span>`)
                        .join("");

                    return `
                        <br>
                        <div class="contentBg changelog-entry">
                            <div class="changelog-header">
                                <div>
                                    <div class="title">${entry.version}&nbsp;&nbsp;·&nbsp;&nbsp;${entry.date}</div>
                                </div>
                                ${entry.download ? `<a class="menuLinkAlt2" href="${entry.download}" download target="_blank">Download Release Notes</a>` : ""}
                            </div>
                            <div class="changelog-lists">
                                <ul><div class="description">${entry.summary}</div>${details}
                                    <div class="changelogContentBg">
                                    <hr>
                                    ${tags ? `<div class="changelog-tags">${tags}</div>  ` : ""}
                                    </div>
                                </ul>
                            </div>

                        </div>`;
                })
                .join("");
        }

        function applyFilter() {
            const query = filterInput?.value.trim().toLowerCase() || "";
            if (!query) {
                renderChangelog(changelogEntries);
                return;
            }
            const filtered = changelogEntries.filter(entry => highlightMatches(entry, query));
            renderChangelog(filtered);
        }

        filterInput?.addEventListener("input", applyFilter);

        fetch("Assets/EQT Updates/changelog.json")
            .then(res => {
                if (!res.ok) throw new Error("Could not load changelog data.");
                return res.json();
            })
            .then(data => {
                changelogEntries = data;
                applyFilter();
            })
            .catch(err => {
                changelogContainer.innerHTML = `<br><div class="contentBg">Failed to load changelog (${err.message})</div>`;
            });
    </script>
</body>

</html>